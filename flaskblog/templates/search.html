{% extends "layout.html" %}

{% block content %}

<!-- Store results JSON in a hidden element -->
<div id="results-data" style="display:none;">
    {{ serialized_results | tojson }}
</div>

<script>
    async function summarizePost() {
        document.getElementById('summarizeButton').style.display = 'none';;
        summarizeButton.disabled = true;  // Disable the button
        document.getElementById('wait').style.display = 'block';
        document.getElementById('summarized').style.display = 'none';
        // Read results data from the hidden element and parse it
        const resultsData = document.getElementById("results-data").textContent;
        console.log(resultsData)
        const results = JSON.parse(resultsData);
        const response = await fetch(`/summarise`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                results: results.map(result => result.content)  // Pass only post content for summarization
            })
        });
        
        if (response.ok) {
            const summary = await response.json();
            document.querySelector(`#summarized`).innerText = summary.summary_text;
        } else {
            document.querySelector(`#summarized`).innerText = "Summary generation failed!";
        }
        // Hide the wait div (loader) and show the summary
        document.getElementById('wait').style.display = 'none';
        document.getElementById('summarized').style.display = 'block';
    }
</script>

<!-- Button and Summary Output -->
<button id="summarizeButton" onclick="summarizePost()">Summarize</button>
<div id="wait" class="loader" style="display:none;"></div>
<div id="summarized" class="summary"></div>
<div class="row">

    <!-- Display Search Results -->
    {% for post in results %}
    
    <div class="card">
        <a class="card-link" href="{{ url_for('post', post_id=post.id) }}">
            <!-- Upper Section -->
            <div class="upper-section">
            <div class="company-logo">
                <img src="{{ url_for('static', filename='logos/' + post.title|lower + '.svg') }}" alt="{{ post.title }} Logo">
            </div>
            <div class="detail-section">
                <div>{{ post.title }} | {{ post.role }} | {{ post.interview_date }}</div>
                <div class="info">
                    <span>Rounds: {{ post.round }}</span> |
                    <span>{{ post.coding_problems }}</span>
                </div>
            </div>
        </div>
        
        <!-- Profile Details Section -->
        <div class="profile-details">
            <div class="profile-image">
                <img src="{{ post.author.image_file }}" alt="User Profile">
            </div>
            <div class="profile-info">
                <div class="name">{{ post.author.name }}</div>
                <div class="experience">{{ post.user_experience }}</div>
                <div class="status">{{ post.verdict }}</div>
            </div>
        </div>
        
        <!-- Engagement Section -->
        <div class="engagement">
            <div><i class="fas fa-eye"></i> {{ post.views }}</div>
            <div><i class="fas fa-comments"></i> {{ post.comments }}</div>
            <div><i class="fas fa-thumbs-up"></i> {{ post.upvotes }}</div>
        </div>
    </a>
</div>

{% endfor %}
{% endblock content %}
